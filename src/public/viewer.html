<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | SafeWatch</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="container">

        <header>
            <div class="logo">
                <ion-icon name="eye"></ion-icon>
                <span>التحكم والمشاهدة</span>
            </div>
            <a href="index.html" style="color:white; text-decoration:none;">خروج</a>
        </header>

        <!-- Connection Wait Screen -->
        <div id="setup-screen" class="setup-screen">
            <h2>امسح الرمز بواسطة الهاتف "الكاميرا"</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">قم بفتح الرابط التالي في الهاتف الذي تريد استخدامه
                ككاميرا مراقبة</p>

            <div id="qrcode" class="qr-code-placeholder"></div>

            <div class="link-box" id="link-display"></div>

            <div style="margin-top: 20px;">
                <div class="status-indicator offline">
                    <ion-icon name="ellipse"></ion-icon>
                    في انتظار الاتصال...
                </div>
            </div>
        </div>

        <!-- Dashboard (Hidden initially) -->
        <div id="dashboard" class="dashboard-grid" style="display: none;">

            <!-- Video Feed -->
            <div class="video-container" style="position: relative;">
                <video id="remoteVideo" autoplay playsinline muted></video>
                <img id="fallback-video" style="display: none; width: 100%; height: 100%; object-fit: contain;" />

                <div
                    style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; text-align: center; width: 100%;">
                    <button id="toggle-compat-btn" onclick="toggleCompatibilityMode()"
                        style="background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border: 1px solid white; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;">
                        تواجه مشكلة؟ اضغط هنا (وضع التوافق)
                    </button>
                </div>

                <button id="play-stream-btn"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; z-index: 20;">
                    <ion-icon name="play-circle" style="vertical-align: middle; margin-right: 5px;"></ion-icon>
                    تشغيل البث يدوياً
                </button>
                <div
                    style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; color: red; display: flex; align-items: center; gap: 5px;">
                    <ion-icon name="radio-button-on"></ion-icon> مباشر
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-panel">
                <div class="control-group">
                    <h3>حالة الجهاز</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div class="status-indicator">
                            <ion-icon name="battery-full"></ion-icon>
                            <span id="battery-level">--%</span>
                        </div>
                        <div class="status-indicator">
                            <ion-icon name="wifi"></ion-icon>
                            متصل
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>التحكم بالكاميرا</h3>

                    <button class="action-btn" onclick="sendCommand('switch-camera')">
                        <ion-icon name="camera-reverse"></ion-icon>
                        تبديل الكاميرا (أمامية/خلفية)
                    </button>

                    <button class="action-btn" onclick="sendCommand('toggle-torch')">
                        <ion-icon name="flash"></ion-icon>
                        تشغيل/إيقاف الفلاش
                    </button>

                    <!-- Zoom Control -->
                    <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <label style="display:block; margin-bottom:5px; font-size:0.9rem;">التقريب (Zoom): <span
                                id="zoom-val">1x</span></label>
                        <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1"
                            style="width: 100%; cursor: pointer;">
                    </div>

                    <button class="action-btn" onclick="sendCommand('screen-dim')">
                        <ion-icon name="lock-closed"></ion-icon>
                        الوضع الأمني (قفل وهمي للشاشة)
                    </button>

                    <!-- Snapshot Mode Toggle -->
                    <button id="snapshot-mode-btn" class="action-btn" onclick="toggleSnapshotMode()"
                        style="border: 1px solid var(--primary);">
                        <ion-icon name="images"></ion-icon>
                        تفعيل وضع اللقطات (صور كل 5 ثواني)
                    </button>
                </div>

                <div class="control-group">
                    <h3>مراقبة متقدمة</h3>

                    <button class="action-btn" onclick="sendCommand('capture-photo')"
                        style="background: var(--accent); border: none;">
                        <ion-icon name="camera"></ion-icon>
                        التقاط صورة فورية (عالية الجودة)
                    </button>

                    <div
                        style="margin: 10px 0; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid var(--accent);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 700;">التحديث التلقائي (صور)</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-snap-toggle" onchange="toggleAutoSnapshot()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">يرسل التطبيق لقطة
                            كل:</p>
                        <select id="snap-interval" onchange="updateSnapshotInterval()"
                            style="width: 100%; padding: 8px; border-radius: 5px; background: var(--bg-dark); color: white; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="1">دقيقة واحدة</option>
                            <option value="5" selected>5 دقائق</option>
                            <option value="15">15 دقيقة</option>
                            <option value="30">30 دقيقة</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>جودة وكفاءة</h3>
                </div>

                <!-- Gallery / History Section -->
                <div class="controls-panel" style="margin-top: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin:0;"><ion-icon name="images-outline"
                                style="vertical-align: middle; margin-left: 5px;"></ion-icon> سجل الصور الملتقطة</h3>
                        <button onclick="clearGallery()"
                            style="background: none; border: 1px solid var(--danger); color: var(--danger); padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">مسح
                            السجل</button>
                    </div>

                    <div id="photo-gallery"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                        <!-- Photos will appear here -->
                        <div id="no-photos-msg"
                            style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">
                            لم يتم التقاط أي صور بعد...
                        </div>
                    </div>
                </div>

                <script>
                    const socket = io();
                    const urlParams = new URLSearchParams(window.location.search);
                    const roomId = urlParams.get('session');
                    const setupScreen = document.getElementById('setup-screen');
                    const dashboard = document.getElementById('dashboard');
                    const remoteVideo = document.getElementById('remoteVideo');

                    if (!roomId) {
                        alert('رقم الجلسة مفقود!');
                        window.location.href = 'index.html';
                    }

                    // Generate QR Code
                    const monitorUrl = `${window.location.protocol}//${window.location.host}/monitor.html?session=${roomId}`;
                    document.getElementById('link-display').innerText = monitorUrl;

                    new QRCode(document.getElementById("qrcode"), {
                        text: monitorUrl,
                        width: 200,
                        height: 200
                    });

                    // Join Room
                    socket.emit('join-room', roomId, 'viewer');

                    // WebRTC
                    let peerConnection;
                    const offsetConfig = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' }
                        ]
                    };

                    socket.on('user-connected', async (role) => {
                        if (role === 'monitor') {
                            console.log('Monitor connected! Starting connection...');
                            startConnection();
                            // Switch UI
                            setupScreen.style.display = 'none';
                            dashboard.style.display = 'grid';
                        }
                    });

                    async function startConnection() {
                        peerConnection = new RTCPeerConnection(offsetConfig);

                        peerConnection.onconnectionstatechange = () => {
                            console.log("Connection State:", peerConnection.connectionState);
                            if (peerConnection.connectionState === 'connected') {
                                document.querySelector('.status-indicator').innerHTML = '<ion-icon name="wifi"></ion-icon> متصل بنجاح';
                                document.querySelector('.status-indicator').style.color = 'var(--accent)';
                            } else if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                                alert("فشل الاتصال المباشر. قد يكون بسبب قيود الشبكة (Jameel Firewall etc).");
                            }
                        };

                        // Handle incoming stream
                        peerConnection.ontrack = (event) => {
                            console.log('Stream received with tracks:', event.streams[0].getTracks());
                            const stream = event.streams[0];
                            remoteVideo.srcObject = stream;

                            const playPromise = remoteVideo.play();
                            if (playPromise !== undefined) {
                                playPromise.catch(error => {
                                    console.error("Autoplay failed:", error);
                                    // Show Manual Play Button
                                    const playBtn = document.getElementById('play-stream-btn');
                                    playBtn.style.display = 'block';
                                    playBtn.addEventListener('click', () => {
                                        remoteVideo.play();
                                        playBtn.style.display = 'none';
                                    });
                                });
                            }
                        };

                        peerConnection.onicecandidate = (event) => {
                            if (event.candidate) {
                                socket.emit('ice-candidate', { roomId, candidate: event.candidate });
                            }
                        };

                        peerConnection.addTransceiver('video', { direction: 'recvonly' });
                        peerConnection.addTransceiver('audio', { direction: 'recvonly' });

                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);
                        socket.emit('offer', { roomId, sdp: offer });
                    }

                    let iceCandidatesQueue = [];

                    socket.on('answer', async (payload) => {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.sdp));

                        // Process queued candidates
                        while (iceCandidatesQueue.length > 0) {
                            const candidate = iceCandidatesQueue.shift();
                            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        }
                    });

                    socket.on('ice-candidate', async (payload) => {
                        if (peerConnection && peerConnection.remoteDescription) {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
                        } else {
                            iceCandidatesQueue.push(payload.candidate);
                        }
                    });

                    socket.on('status-update', (payload) => {
                        if (payload.type === 'battery') {
                            const batteryLevel = payload.level + '%';
                            const isCharging = payload.charging;

                            const batteryText = document.getElementById('battery-level');
                            const batteryIcon = batteryText.previousElementSibling; // The ion-icon

                            batteryText.innerText = batteryLevel;

                            if (isCharging) {
                                batteryIcon.name = 'battery-charging';
                                batteryIcon.style.color = '#10b981';
                            } else if (payload.level < 20) {
                                batteryIcon.name = 'battery-dead';
                                batteryIcon.style.color = '#ef4444';
                            } else {
                                batteryIcon.name = 'battery-full';
                                batteryIcon.style.color = 'var(--accent)';
                            }
                        }
                    });

                    // Controls
                    function sendCommand(command) {
                        socket.emit('control-command', { roomId, command });
                    }
                    // Fallback Stream Handler
                    const fallbackVideo = document.getElementById('fallback-video');
                    let isCompatMode = false;

                    socket.on('stream-data', (image) => {
                        fallbackVideo.src = image;
                    });

                    function toggleCompatibilityMode() {
                        const btn = document.getElementById('toggle-compat-btn');
                        if (!isCompatMode) {
                            // Switch ON
                            isCompatMode = true;
                            remoteVideo.style.display = 'none';
                            fallbackVideo.style.display = 'block';
                            btn.innerText = "العودة للوضع المتطور (HD)";
                            btn.style.background = "#f59e0b";
                            // Standard Compat Mode = Fast Frames
                            socket.emit('control-command', { roomId, command: 'start-compatibility-mode', interval: 100 });
                        } else {
                            // Switch OFF
                            isCompatMode = false;
                            remoteVideo.style.display = 'block';
                            fallbackVideo.style.display = 'none';
                            btn.innerText = "تواجه مشكلة؟ اضغط هنا (وضع التوافق)";
                            btn.style.background = "rgba(255,255,255,0.2)";
                            sendCommand('stop-compatibility-mode');
                        }
                    }

                    // Snapshot Mode Logic
                    let isSnapshotMode = false;
                    function toggleSnapshotMode() {
                        const btn = document.getElementById('snapshot-mode-btn');
                        const compatBtn = document.getElementById('toggle-compat-btn');

                        if (!isSnapshotMode) {
                            isSnapshotMode = true;
                            btn.classList.add('active');
                            btn.innerText = "إيقاف وضع اللقطات";

                            // Force switch to image view
                            remoteVideo.style.display = 'none';
                            fallbackVideo.style.display = 'block';
                            compatBtn.style.display = 'none'; // Hide compat button as we are using a variant of it

                            // Start slow updates (every 5 seconds)
                            socket.emit('control-command', { roomId, command: 'start-compatibility-mode', interval: 5000 });
                        } else {
                            isSnapshotMode = false;
                            btn.classList.remove('active');
                            btn.innerText = "تفعيل وضع اللقطات (صور كل 5 ثواني)";

                            // Stop
                            socket.emit('control-command', { roomId, command: 'stop-compatibility-mode' });

                            // Return to normal
                            remoteVideo.style.display = 'block';
                            fallbackVideo.style.display = 'none';
                            compatBtn.style.display = 'block';
                        }
                    }

                    // Auto Snapshot Logic
                    function toggleAutoSnapshot() {
                        const isEnabled = document.getElementById('auto-snap-toggle').checked;
                        const minutes = parseInt(document.getElementById('snap-interval').value);
                        socket.emit('control-command', { roomId, command: 'set-auto-snapshot', enabled: isEnabled, minutes: minutes });

                        if (isEnabled) {
                            console.log(`Auto-snapshot set for every ${minutes} mins`);
                        }
                    }

                    function updateSnapshotInterval() {
                        const isEnabled = document.getElementById('auto-snap-toggle').checked;
                        if (isEnabled) toggleAutoSnapshot(); // Re-trigger with new interval
                    }

                    // Zoom Logic
                    const zoomSlider = document.getElementById('zoom-slider');
                    const zoomVal = document.getElementById('zoom-val');

                    zoomSlider.addEventListener('input', (e) => {
                        const value = e.target.value;
                        zoomVal.innerText = value + 'x';
                        socket.emit('control-command', { roomId, command: 'set-zoom', value: parseFloat(value) });
                    });

                    // Handle Snapshot Notifications & Gallery
                    socket.on('stream-data', (payload) => {
                        const imageData = payload.isSnapshot ? payload.image : payload;

                        // Update fallback video view
                        fallbackVideo.src = imageData;

                        if (payload.isSnapshot) {
                            // Add to gallery
                            addToGallery(imageData);

                            if (!isCompatMode && !isSnapshotMode) {
                                // Temporarily show the snapshot if we are in live mode
                                fallbackVideo.style.display = 'block';
                                remoteVideo.style.display = 'none';
                                setTimeout(() => {
                                    if (!isCompatMode && !isSnapshotMode) {
                                        fallbackVideo.style.display = 'none';
                                        remoteVideo.style.display = 'block';
                                    }
                                }, 3000);
                            }
                        }
                    });

                    function addToGallery(data) {
                        const gallery = document.getElementById('photo-gallery');
                        const noMsg = document.getElementById('no-photos-msg');
                        if (noMsg) noMsg.remove();

                        const time = new Date().toLocaleTimeString('ar-EG');

                        const item = document.createElement('div');
                        item.style = "background: #0f172a; border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);";
                        item.innerHTML = `
                <img src="${data}" style="width: 100%; height: 120px; object-fit: cover;">
                <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.7rem; color: #94a3b8;">${time}</span>
                    <a href="${data}" download="SafeWatch_${Date.now()}.jpg" style="color: var(--accent); font-size: 1.2rem;">
                        <ion-icon name="download-outline"></ion-icon>
                    </a>
                </div>
            `;
                        gallery.prepend(item);
                    }

                    function clearGallery() {
                        if (confirm("هل تريد مسح جميع الصور من السجل؟")) {
                            const gallery = document.getElementById('photo-gallery');
                            gallery.innerHTML = '<div id="no-photos-msg" style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">لم يتم التقاط أي صور بعد...</div>';
                        }
                    }
                </script>
</body>

</html>