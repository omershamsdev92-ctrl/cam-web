<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الكاميرا | SafeWatch</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body,
        html {
            height: 100%;
            overflow: hidden;
            background: black;
        }

        #localVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .monitor-status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10;
        }

        #dim-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            pointer-events: none;
            /* Let clicks pass through if needed, or handle taps to wake */
            z-index: 999;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>

    <div id="permission-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; text-align: center; padding: 20px;">
        <ion-icon name="videocam" style="font-size: 4rem; color: #3b82f6; margin-bottom: 20px;"></ion-icon>
        <h2 style="margin-bottom: 10px;">إعداد الكاميرا</h2>
        <p style="margin-bottom: 30px; font-size: 1.1rem; color: #94a3b8;">اضغط على الزر أدناه للبدء</p>
        <button id="start-btn" class="btn"
            style="background: #10b981; border: none; padding: 15px 40px; border-radius: 50px; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
            حسناً للاستمرار
        </button>
    </div>

    <video id="localVideo" autoplay playsinline muted></video>

    <div class="monitor-status" id="status-text" style="transition: opacity 0.5s;">
        جاري الانتظار...
    </div>

    <div id="dim-overlay" style="opacity: 0;"></div>

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('session');
        const localVideo = document.getElementById('localVideo');
        const permissionOverlay = document.getElementById('permission-overlay');
        const dimOverlay = document.getElementById('dim-overlay');
        const statusText = document.getElementById('status-text');

        let peerConnection;
        let localStream;
        let currentFacingMode = 'environment';
        let wakeLock = null;

        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        if (!roomId) {
            alert('No Session ID');
            window.location.href = '/';
        }

        // 1. Wake Lock (Keep Screen Alive)
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock is active!');
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        // 2. Custom Permission Button Handler
        document.getElementById('start-btn').addEventListener('click', async () => {
            permissionOverlay.style.display = 'none';
            await getCamera(currentFacingMode);
            await requestWakeLock(); // Keep screen on

            socket.emit('join-room', roomId, 'monitor');
            statusText.innerText = "الكاميرا جاهزة. في انتظار المشاهد...";
        });

        async function getCamera(facingMode = 'environment') {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusText.innerText = "المتصفح لا يدعم الوصول للكاميرا (تأكد من HTTPS).";
                return;
            }

            try {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });

                localStream = stream;
                localVideo.srcObject = stream;

                // Refresh connection if active
                if (peerConnection) {
                    const videoTrack = stream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(videoTrack);
                }

                return stream;
            } catch (err) {
                console.error("Camera error:", err);
                statusText.innerText = "خطأ الكاميرا: " + err.message;
            }
        }

        // Socket Events
        let iceCandidatesQueue = [];

        socket.on('offer', async (payload) => {
            console.log("Received Offer");
            statusText.innerText = "تم الاتصال! البث مباشر الآن.";
            statusText.style.background = "green";

            peerConnection = new RTCPeerConnection(config);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { roomId, candidate: event.candidate });
                }
            };

            await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.sdp));

            while (iceCandidatesQueue.length > 0) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidatesQueue.shift()));
            }

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            socket.emit('answer', { roomId, sdp: answer });

            startBatteryUpdates();
        });

        socket.on('ice-candidate', async (payload) => {
            if (peerConnection && peerConnection.remoteDescription) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
            } else {
                iceCandidatesQueue.push(payload.candidate);
            }
        });

        socket.on('control-command', async (payload) => {
            console.log("Command received:", payload.command);

            if (payload.command === 'switch-camera') {
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                await getCamera(currentFacingMode);
            }

            if (payload.command === 'toggle-torch') {
                const track = localStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    try {
                        const currentSettings = track.getSettings();
                        await track.applyConstraints({ advanced: [{ torch: !currentSettings.torch }] });
                    } catch (e) {
                        console.error("Torch error", e);
                    }
                } else {
                    console.warn("Torch not supported on this device/camera.");
                }
            }

            if (payload.command === 'screen-dim') {
                toggleStealthMode();
            }
            if (payload.command === 'start-compatibility-mode') {
                startCanvasStreaming();
            }
            if (payload.command === 'stop-compatibility-mode') {
                stopCanvasStreaming();
            }
        });

        // Helper: Stealth Mode
        function toggleStealthMode() {
            const isHidden = dimOverlay.style.opacity === '1';
            dimOverlay.style.opacity = isHidden ? '0' : '1';
            // Also toggle status text visibility
            statusText.style.display = isHidden ? 'block' : 'none';
        }

        // Add a click listener to the dim overlay to wake it up locally
        dimOverlay.addEventListener('click', () => {
            toggleStealthMode();
        });

        // --- COMPATIBILITY MODE (CANVAS STREAMING) ---
        // Used when WebRTC fails (black screen)
        let canvasInterval = null;
        let framesSent = 0;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        function startCanvasStreaming() {
            if (canvasInterval) clearInterval(canvasInterval);

            statusText.innerHTML = "وضع التوافق يعمل.<br>جاري إرسال الإطارات...";
            statusText.style.background = "#f59e0b"; // Orange

            // Low Resolution for stability
            canvas.width = 320;
            canvas.height = 240;

            canvasInterval = setInterval(() => {
                try {
                    if (localVideo.readyState >= 2) { // HAVE_CURRENT_DATA
                        ctx.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
                        const data = canvas.toDataURL('image/jpeg', 0.3);
                        socket.emit('stream-data', { roomId, image: data });

                        framesSent++;
                        if (framesSent % 20 === 0) {
                            statusText.innerHTML = `وضع التوافق يعمل.<br>تم إرسال ${framesSent} إطار`;
                        }
                    } else {
                        statusText.innerText = "الكاميرا لا تعمل/متوقفة (ReadyState: " + localVideo.readyState + ")";
                        localVideo.play(); // Try to wake it
                    }
                } catch (e) {
                    console.error(e);
                    statusText.innerText = "خطأ في التصوير: " + e.message;
                }
            }, 200); // 5 FPS (Slower but safer)
        }

        function stopCanvasStreaming() {
            if (canvasInterval) {
                clearInterval(canvasInterval);
                canvasInterval = null;
                statusText.innerText = "تم إيقاف وضع التوافق.";
                statusText.style.background = "var(--primary)";
            }
        }

        // Expose for debugging if needed
        window.sendTestFrame = () => {
            canvas.width = 320;
            canvas.height = 240;
            ctx.fillStyle = "red";
            ctx.fillRect(0, 0, 320, 240);
            ctx.fillStyle = "white";
            ctx.font = "30px Arial";
            ctx.fillText("TEST FRAME", 50, 120);
            const data = canvas.toDataURL('image/jpeg', 0.5);
            socket.emit('stream-data', { roomId, image: data });
            alert("تم إرسال صورة حمراء اختبارية. تحقق من الشاشة الأخرى.");
        };

        // Battery API
        function startBatteryUpdates() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    sendBattery(battery);
                    battery.addEventListener('levelchange', () => sendBattery(battery));
                    battery.addEventListener('chargingchange', () => sendBattery(battery));
                });
            } else {
                console.log("Battery API not supported on this device.");
            }
        }

        function sendBattery(battery) {
            const level = Math.round(battery.level * 100);
            socket.emit('status-update', {
                roomId,
                type: 'battery',
                level: level,
                charging: battery.charging
            });
        }
    </script>
</body>

</html>